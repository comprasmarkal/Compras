<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCGyMwZj4jSoc3Aur0IW3eH7CUFxI5Hxsw",
    authDomain: "markal-compras-26db2.firebaseapp.com",
    projectId: "markal-compras-26db2",
    storageBucket: "markal-compras-26db2.appspot.com",
    messagingSenderId: "658824602590",
    appId: "1:658824602590:web:38cce5d865d4ca227d734f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  const salvarNoFirestore = async (produto) => {
    try {
      await addDoc(collection(db, "produtos"), produto);
      console.log("Produto salvo no Firestore");
    } catch (err) {
      console.error("Erro ao salvar no Firestore:", err);
    }
  };

  const carregarProdutos = async () => {
    const listaProdutos = document.getElementById("listaProdutos");
    listaProdutos.innerHTML = "";

    try {
      const querySnapshot = await getDocs(collection(db, "produtos"));
      console.log("Produtos encontrados:", querySnapshot.size);
      querySnapshot.forEach((doc) => {
        console.log(doc.id, "=>", doc.data());
        const produto = doc.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${produto.codigo}</td>
          <td>${produto.descricao}</td>
          <td>${produto.fornecedor}</td>
          <td>${produto.imagem ? `<img src="${produto.imagem}" class="prod-img" />` : ''}</td>
          <td><button class="small-btn" onclick="alert('Funcionalidade a implementar')">Editar</button></td>
        `;
        listaProdutos.appendChild(tr);
      });
    } catch (err) {
      console.error("Erro ao carregar produtos:", err);
    }
  };

  document.addEventListener("DOMContentLoaded", () => {
    carregarProdutos();

    const formP = document.getElementById("formProduto");
    formP.onsubmit = async (e) => {
      e.preventDefault();

      const cd = document.getElementById("produtoCodigo").value.trim();
      const ds = document.getElementById("produtoDescricao").value.trim();
      const fr = document.getElementById("produtoFornecedor").value.trim();

      let img = "";
      const file = document.getElementById("produtoImagem").files[0];
      if (file) {
        img = await new Promise((resolve) => {
          const reader = new FileReader();
          reader.onload = () => resolve(reader.result);
          reader.readAsDataURL(file);
        });
      }

      const produto = { codigo: cd, descricao: ds, fornecedor: fr, imagem: img, criadoEm: new Date() };
      await salvarNoFirestore(produto);
      alert("Produto enviado ao Firebase!");
      formP.reset();

      carregarProdutos();
    };
  });
</script>
