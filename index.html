<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Markal - Produtos</title>
  <style>
    body { font-family: Arial; }
    table { border-collapse: collapse; width: 100%; margin-top: 20px; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background-color: #94d2bd; }
    img.prod-img { max-width: 50px; max-height: 50px; object-fit: contain; }
  </style>
</head>
<body>

<h1>Cadastro de Produto</h1>
<form id="formProduto">
  Código: <input type="text" id="produtoCodigo" required />
  Descrição: <input type="text" id="produtoDescricao" required />
  Fornecedor: <input type="text" id="produtoFornecedor" required />
  Imagem: <input type="file" id="produtoImagem" accept="image/*" />
  <button type="submit">Adicionar Produto</button>
</form>

<h2>Produtos Cadastrados</h2>
<table>
  <thead>
    <tr><th>Código</th><th>Descrição</th><th>Fornecedor</th><th>Imagem</th></tr>
  </thead>
  <tbody id="listaProdutos"></tbody>
</table>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

  // Config Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCGyMwZj4jSoc3Aur0IW3eH7CUFxI5Hxsw",
    authDomain: "markal-compras-26db2.firebaseapp.com",
    projectId: "markal-compras-26db2",
    storageBucket: "markal-compras-26db2.appspot.com",
    messagingSenderId: "658824602590",
    appId: "1:658824602590:web:38cce5d865d4ca227d734f"
  };

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // Referência da coleção
  const produtosRef = collection(db, "produtos");

  // Pega o formulário e lista tbody
  const formProduto = document.getElementById("formProduto");
  const listaProdutos = document.getElementById("listaProdutos");

  // Escuta submissão do formulário
  formProduto.addEventListener("submit", async e => {
    e.preventDefault();
    const codigo = document.getElementById("produtoCodigo").value.trim();
    const descricao = document.getElementById("produtoDescricao").value.trim();
    const fornecedor = document.getElementById("produtoFornecedor").value.trim();

    // Lê imagem como base64 se houver
    const inputImagem = document.getElementById("produtoImagem");
    let imagem = "";
    if (inputImagem.files.length > 0) {
      imagem = await new Promise(resolve => {
        const reader = new FileReader();
        reader.onload = () => resolve(reader.result);
        reader.readAsDataURL(inputImagem.files[0]);
      });
    }

    // Adiciona no Firestore
    try {
      await addDoc(produtosRef, {
        codigo,
        descricao,
        fornecedor,
        imagem,
        criadoEm: new Date()
      });
      alert("Produto salvo no Firebase!");
      formProduto.reset();
    } catch (err) {
      alert("Erro ao salvar: " + err.message);
    }
  });

  // Escuta mudanças na coleção em tempo real
  onSnapshot(produtosRef, (snapshot) => {
    listaProdutos.innerHTML = ""; // limpa lista
    snapshot.forEach(doc => {
      const p = doc.data();
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${p.codigo}</td>
        <td>${p.descricao}</td>
        <td>${p.fornecedor}</td>
        <td>${p.imagem ? `<img src="${p.imagem}" class="prod-img" />` : ""}</td>
      `;
      listaProdutos.appendChild(tr);
    });
  });
</script>

</body>
</html>
